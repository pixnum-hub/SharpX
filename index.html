<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SharpX â€“ Mobile-Friendly Final PWA</title>
<link rel="manifest" href="manifest.json">
<style>
*{box-sizing:border-box;margin:0;padding:0}
body{
  min-height:100vh;
  display:flex;
  justify-content:center;
  align-items:flex-start;
  background:linear-gradient(135deg,#1d2671,#c33764);
  font-family:system-ui;
  transition:.3s;
  padding:10px;
}
body.dark{background:linear-gradient(135deg,#000,#222);color:#fff;}
.app{
  width:95%;
  max-width:520px;
  margin:0 auto;
  background:rgba(255,255,255,.18);
  backdrop-filter:blur(14px);
  border-radius:20px;
  padding:12px;
  color:#fff;
}
.header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  flex-wrap:wrap;
  margin-bottom:10px;
}
.header h2{font-size:1.2rem; flex:1 1 auto; min-width:120px;}
.header button{
  width:40px; height:40px;
  border-radius:50%;
  border:none;
  font-size:18px;
  cursor:pointer;
  background:rgba(255,255,255,.25);
  color:#fff;
  flex:0 0 auto;
  margin-top:5px;
}
canvas{display:block;width:100%;height:auto;border-radius:14px;}
.canvas-wrap{
  position:relative;
  overflow:hidden;
  border-radius:14px;
  background:#000;
  touch-action:none;
  width:100%;
  max-width:100%;
}
.split{
  position:absolute; top:0; bottom:0;
  width:20px; margin-left:-10px;
  background:rgba(255,255,255,.7);
  border-radius:6px;
  touch-action:none;
  cursor:ew-resize;
}
.controls{margin-top:10px;display:grid;gap:8px;}
label{font-size:.85rem;}
input,select,button{
  width:100%;
  padding:8px;
  border-radius:10px;
  border:none;
}
button{
  background:rgba(255,255,255,.25);
  color:#fff;
  font-weight:600;
  cursor:pointer;
}
.info{
  font-size:.8rem;
  opacity:.85;
}
footer{
  margin-top:8px;
  font-size:.75rem;
  text-align:center;
  opacity:.8;
}

/* MOBILE SMALL SCREEN FIXES */
@media (max-width:400px){
  .header h2{font-size:1rem;}
  .controls input, .controls select, .controls button{font-size:0.85rem; padding:6px;}
}
</style>
</head>
<body>
<div class="app">

  <!-- Header -->
  <div class="header">
    <h2>SharpX</h2>
    <button id="darkToggle">ðŸŒ™</button>
  </div>

  <!-- Upload + Camera -->
  <input type="file" id="upload" accept="image/*">
  <button id="cameraBtn">Open Camera</button>
  <video id="camera" playsinline autoplay style="display:none;width:100%"></video>
  <button id="captureBtn" style="display:none">Capture</button>

  <!-- Canvas + Split -->
  <div class="canvas-wrap" id="wrap">
    <canvas id="canvas"></canvas>
    <div class="split" id="split"></div>
  </div>

  <!-- Controls -->
  <div class="controls">
    <label>Sharpness</label>
    <input type="range" id="sharp" min="0" max="3" step="0.01" value="1">

    <label>Zoom</label>
    <input type="range" id="zoom" min="1" max="2" step="0.01" value="1">

    <label>Upscale</label>
    <select id="upscale">
      <option value="1">None</option>
      <option value="2">2Ã—</option>
      <option value="4">4Ã—</option>
    </select>

    <label>DPI</label>
    <input type="number" id="dpiInput" value="300" min="72" max="600">

    <label>Export Format</label>
    <select id="format">
      <option value="png">PNG</option>
      <option value="jpeg">JPEG</option>
    </select>

    <label>JPEG Quality</label>
    <input type="range" id="jpgQuality" min="0.8" max="1" step="0.01" value="0.92">

    <div class="info" id="info"></div>

    <button id="download">Download</button>
  </div>

  <footer>SharpX Â· Final Clean Build</footer>
</div>

<script>
/* ========= VARIABLES ========= */
const canvas=document.getElementById("canvas");
const ctx=canvas.getContext("2d");
const wrap=document.getElementById("wrap");
const split=document.getElementById("split");

const sharp=document.getElementById("sharp");
const zoom=document.getElementById("zoom");
const upscaleSel=document.getElementById("upscale");
const dpiInput=document.getElementById("dpiInput");
const info=document.getElementById("info");
const formatSel=document.getElementById("format");
const jpgQuality=document.getElementById("jpgQuality");

const cameraBtn = document.getElementById("cameraBtn");
const camera = document.getElementById("camera");
const captureBtn = document.getElementById("captureBtn");
const darkToggle=document.getElementById("darkToggle");

let img=null, originalImg=null;
let base={w:0,h:0};
let splitX=0.5;
let pan={x:0,y:0}, panStart={}, pointerStart={};
let panning=false, draggingSplit=false;
let stream=null;

/* ========= IMAGE LOAD ========= */
upload.onchange=e=>{
  const f=e.target.files[0]; if(!f) return;
  const r=new FileReader();
  r.onload=()=>{
    const i=new Image();
    i.onload=()=>{originalImg=img=i;base.w=i.width;base.h=i.height;fitCanvas();resetPan();draw();updateInfo();}
    i.src=r.result;
  };
  r.readAsDataURL(f);
};

/* ========= CAMERA INPUT ========= */
cameraBtn.onclick=async()=>{
  stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});
  camera.srcObject=stream;
  camera.style.display="block";
  captureBtn.style.display="block";
};
captureBtn.onclick=()=>{
  const c=document.createElement("canvas");
  c.width=camera.videoWidth; c.height=camera.videoHeight;
  c.getContext("2d").drawImage(camera,0,0);
  const i=new Image();
  i.onload=()=>{
    originalImg=img=i; base.w=i.width;base.h=i.height;
    fitCanvas(); resetPan(); draw(); updateInfo();
  };
  i.src=c.toDataURL();
  stream.getTracks().forEach(t=>t.stop());
  camera.style.display=captureBtn.style.display="none";
};

/* ========= DARK MODE ========= */
darkToggle.onclick=()=>document.body.classList.toggle("dark");

/* ========= FIT CANVAS ========= */
function fitCanvas(){
  const w=wrap.clientWidth;
  const s=w/base.w;
  canvas.width=base.w*s; canvas.height=base.h*s;
}
function resetPan(){pan.x=pan.y=0;}
function clampPan(){
  const z=zoom.value;
  const mx=(canvas.width*(z-1))/2;
  const my=(canvas.height*(z-1))/2;
  pan.x=Math.max(-mx,Math.min(mx,pan.x));
  pan.y=Math.max(-my,Math.min(my,pan.y));
}

/* ========= SHARPEN ========= */
function sharpenData(img,a){
  if(a<=0) return img;
  const d=img.data,o=new Uint8ClampedArray(d);
  const k=[0,-1,0,-1,5,-1,0,-1,0];
  for(let y=1;y<img.height-1;y++)
  for(let x=1;x<img.width-1;x++)
  for(let c=0;c<3;c++){
    let v=0,i=(y*img.width+x)*4+c,ki=0;
    for(let ky=-1;ky<=1;ky++)
    for(let kx=-1;kx<=1;kx++)
      v+=o[((y+ky)*img.width+(x+kx))*4+c]*k[ki++];
    d[i]=o[i]*(1-a)+v*a;
  }
  return img;
}

/* ========= DRAW ========= */
function draw(){
  if(!img) return;
  clampPan();
  const z=zoom.value;
  const cw=canvas.width,ch=canvas.height;
  const dw=cw*z,dh=ch*z;
  const dx=(cw-dw)/2+pan.x, dy=(ch-dh)/2+pan.y;
  ctx.clearRect(0,0,cw,ch);
  ctx.drawImage(img,dx,dy,dw,dh);
  let id=ctx.getImageData(0,0,cw,ch);
  id=sharpenData(id,sharp.value/3);
  ctx.putImageData(id,0,0);
  ctx.drawImage(canvas,0,0,cw*splitX,ch,0,0,cw*splitX,ch);
  split.style.left=(splitX*100)+"%";
}
sharp.oninput=draw; zoom.oninput=()=>{resetPan();draw();};

/* ========= PAN EVENTS ========= */
wrap.onpointerdown=e=>{
  if(e.target===split||zoom.value<=1) return;
  panning=true; pointerStart={x:e.clientX,y:e.clientY}; panStart={x:pan.x,y:pan.y};
  wrap.setPointerCapture(e.pointerId);
};
wrap.onpointermove=e=>{if(!panning) return; pan.x=panStart.x+(e.clientX-pointerStart.x); pan.y=panStart.y+(e.clientY-pointerStart.y); draw();};
wrap.onpointerup=e=>{panning=false; wrap.releasePointerCapture(e.pointerId);};

/* ========= SPLIT ========= */
split.onpointerdown=e=>{draggingSplit=true; split.setPointerCapture(e.pointerId);}
split.onpointermove=e=>{if(!draggingSplit) return; const r=wrap.getBoundingClientRect(); splitX=Math.max(0,Math.min(1,(e.clientX-r.left)/r.width)); draw();}
split.onpointerup=e=>{draggingSplit=false; split.releasePointerCapture(e.pointerId);};

/* ========= UPSCALE ========= */
upscaleSel.onchange=()=>{
  const f=+upscaleSel.value;
  if(f===1){img=originalImg}
  else{
    const c=document.createElement("canvas");
    c.width=originalImg.width*f; c.height=originalImg.height*f;
    c.getContext("2d").drawImage(originalImg,0,0,c.width,c.height);
    const i=new Image(); i.onload=()=>{img=i;base.w=i.width;base.h=i.height; fitCanvas(); resetPan(); draw(); updateInfo();};
    i.src=c.toDataURL();
  }
  splitX=1; draw(); updateInfo();
};

/* ========= INFO ========= */
function updateInfo(){
  if(!img) return;
  const dpi=+dpiInput.value; const w=img.width,h=img.height;
  info.innerHTML=`Image: ${w}Ã—${h}px<br>Print @${dpi} DPI: ${(w/dpi).toFixed(2)}" Ã— ${(h/dpi).toFixed(2)}"`;
}
dpiInput.oninput=updateInfo;

/* ========= DOWNLOAD ========== */
download.onclick=()=>{
  const dpi=+dpiInput.value;
  const type=formatSel.value;
  if(type==="jpeg"){
    canvas.toBlob(b=>{
      const a=document.createElement("a");
      a.href=URL.createObjectURL(b);
      a.download="SharpX_PrintReady.jpg";
      a.click();
    },"image/jpeg",+jpgQuality.value);
  } else {
    canvas.toBlob(b=>{
      const r=new FileReader();
      r.onload=()=>{
        const p=new Uint8Array(r.result);
        const out=addDPI(p,Math.round(dpi/0.0254));
        const a=document.createElement("a");
        a.href=URL.createObjectURL(new Blob([out],{type:"image/png"}));
        a.download="SharpX_PrintReady.png";
        a.click();
      };
      r.readAsArrayBuffer(b);
    },"image/png");
  }
};
function addDPI(png,ppm){
  const pHYs=new Uint8Array(21); const d=new DataView(pHYs.buffer);
  d.setUint32(0,9); pHYs.set([112,72,89,115],4); d.setUint32(8,ppm); d.setUint32(12,ppm); pHYs[16]=1; d.setUint32(17,crc32(pHYs.subarray(4,17)));
  return new Uint8Array([...png.slice(0,33),...pHYs,...png.slice(33)]);
}
function crc32(a){let c=-1;for(let b of a){c^=b;for(let k=0;k<8;k++)c=(c>>>1)^(0xEDB88320&-(c&1))}return(c^=-1)>>>0;}

/* ========= PWA REG ========= */
if("serviceWorker" in navigator){
  navigator.serviceWorker.register("sw.js").then(reg=>{
    reg.onupdatefound=()=>{alert("ðŸ”” New version available. Refresh app.");};
  });
}
</script>
</body>
</html>
