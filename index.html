<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SharpX</title>

<style>
*{box-sizing:border-box;margin:0;padding:0}
body{
  min-height:100vh;
  display:flex;
  justify-content:center;
  align-items:center;
  background:linear-gradient(135deg,#1d2671,#c33764);
  font-family:system-ui;
}
.app{
  width:100%;
  max-width:540px;
  background:rgba(255,255,255,.18);
  backdrop-filter:blur(16px);
  border-radius:22px;
  padding:16px;
  color:#fff;
}
.header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:10px;
}
button{
  background:rgba(255,255,255,.25);
  color:#fff;
  border:none;
  border-radius:12px;
  padding:10px;
  font-weight:600;
  cursor:pointer;
}
.controls{display:grid;gap:8px;margin-top:10px}
label{font-size:.85rem}
input[type=range]{width:100%}

.canvas-container{
  position:relative;
  overflow:hidden;
  border-radius:16px;
  touch-action:none;
  user-select:none;
}
canvas{
  display:block;
  background:#000;
  touch-action:none;
}

/* MOBILE-SAFE SPLIT HANDLE */
.splitHandle{
  position:absolute;
  top:0;
  bottom:0;
  width:24px;
  margin-left:-12px;
  background:rgba(255,255,255,.75);
  border-radius:6px;
  cursor:ew-resize;
  z-index:10;
  touch-action:none;
}

.buttons{
  display:flex;
  flex-wrap:wrap;
  gap:8px;
}
footer{
  text-align:center;
  font-size:.75rem;
  opacity:.8;
  margin-top:8px;
}
</style>
</head>

<body>
<div class="app">
  <div class="header">
    <h3>SharpX</h3>
    <button onclick="resetView()">Reset View</button>
  </div>

  <input type="file" id="upload" accept="image/*">

  <div class="canvas-container" id="container">
    <canvas id="canvas"></canvas>
    <div class="splitHandle" id="splitHandle"></div>
  </div>

  <div class="controls">
    <label>Sharpness</label>
    <input type="range" id="sharp" min="0" max="3" step="0.01" value="1">

    <label>Zoom</label>
    <input type="range" id="zoom" min="100" max="300" value="100">

    <label>Upscale</label>
    <div class="buttons">
      <button onclick="upscaleImage(2)">2×</button>
      <button onclick="upscaleImage(4)">4×</button>
      <button onclick="download()">Download</button>
    </div>
  </div>

  <footer>© SharpX</footer>
</div>

<script>
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
const container = document.getElementById("container");
const splitHandle = document.getElementById("splitHandle");
const zoomSlider = document.getElementById("zoom");
const sharp = document.getElementById("sharp");

let original = null;
let zoom = 1;
let offsetX = 0;
let offsetY = 0;
let dragging = false;
let startX = 0;
let startY = 0;
let sx = 0.5;
let splitDragging = false;

/* ---------- IMAGE LOAD ---------- */
upload.onchange = e => {
  const f = e.target.files[0];
  if (!f) return;
  const r = new FileReader();
  r.onload = () => {
    const img = new Image();
    img.onload = () => fit(img);
    img.src = r.result;
  };
  r.readAsDataURL(f);
};

function fit(img){
  const w = container.clientWidth;
  const s = w / img.width;
  canvas.width = img.width * s;
  canvas.height = img.height * s;
  ctx.drawImage(img,0,0,canvas.width,canvas.height);
  original = ctx.getImageData(0,0,canvas.width,canvas.height);
  draw();
}

/* ---------- SHARPEN ---------- */
function sharpenImage(img,a){
  if(a<=0) return img;
  const d=img.data,o=new Uint8ClampedArray(d);
  const k=[0,-1,0,-1,5,-1,0,-1,0];
  for(let y=1;y<img.height-1;y++)
  for(let x=1;x<img.width-1;x++)
  for(let c=0;c<3;c++){
    let v=0,i=(y*img.width+x)*4+c,ki=0;
    for(let ky=-1;ky<=1;ky++)
    for(let kx=-1;kx<=1;kx++)
      v+=o[((y+ky)*img.width+(x+kx))*4+c]*k[ki++];
    d[i]=o[i]*(1-a)+v*a;
  }
  return img;
}

/* ---------- DRAW ---------- */
function draw(){
  if(!original) return;

  let img=new ImageData(
    new Uint8ClampedArray(original.data),
    original.width,
    original.height
  );

  img=sharpenImage(img, sharp.value/3);
  ctx.putImageData(img,0,0);

  const w = canvas.width;
  ctx.drawImage(canvas,0,0,w*sx,canvas.height,0,0,w*sx,canvas.height);

  splitHandle.style.left = (sx * 100) + "%";
  updateTransform();
}

sharp.oninput = draw;

/* ---------- TRANSFORM ---------- */
function updateTransform(){
  canvas.style.transform =
    `translate(${offsetX}px,${offsetY}px) scale(${zoom})`;
}

/* ---------- PAN (DRAG IMAGE) ---------- */
container.addEventListener("pointerdown", e=>{
  if(zoom<=1) return;
  dragging=true;
  container.setPointerCapture(e.pointerId);
  startX=e.clientX-offsetX;
  startY=e.clientY-offsetY;
});

container.addEventListener("pointermove", e=>{
  if(!dragging) return;
  offsetX=e.clientX-startX;
  offsetY=e.clientY-startY;

  const minX = container.clientWidth - canvas.width * zoom;
  const minY = container.clientHeight - canvas.height * zoom;

  offsetX = Math.min(0, Math.max(minX, offsetX));
  offsetY = Math.min(0, Math.max(minY, offsetY));

  updateTransform();
});

window.addEventListener("pointerup", ()=>dragging=false);

/* ---------- ZOOM ---------- */
zoomSlider.oninput = e=>{
  const prev = zoom;
  zoom = parseInt(e.target.value)/100;

  const cx = container.clientWidth/2;
  const cy = container.clientHeight/2;

  offsetX = cx - ((cx - offsetX) * zoom / prev);
  offsetY = cy - ((cy - offsetY) * zoom / prev);

  updateTransform();
};

/* ---------- MOBILE-SAFE SPLIT ---------- */
splitHandle.addEventListener("pointerdown", e=>{
  e.preventDefault();
  e.stopPropagation();
  splitDragging = true;
  splitHandle.setPointerCapture(e.pointerId);
});

splitHandle.addEventListener("pointermove", e=>{
  if(!splitDragging) return;

  const rect = container.getBoundingClientRect();
  let x = e.clientX - rect.left;
  x = Math.max(0, Math.min(rect.width, x));

  sx = x / rect.width;
  splitHandle.style.left = x + "px";
  draw();
});

splitHandle.addEventListener("pointerup", e=>{
  splitDragging=false;
  splitHandle.releasePointerCapture(e.pointerId);
});

splitHandle.addEventListener("pointercancel", ()=>splitDragging=false);

/* ---------- UPSCALE ---------- */
function upscaleImage(f){
  const off=document.createElement("canvas");
  off.width=canvas.width*f;
  off.height=canvas.height*f;
  off.getContext("2d").drawImage(canvas,0,0,off.width,off.height);

  canvas.width=off.width;
  canvas.height=off.height;
  ctx.drawImage(off,0,0);

  original=ctx.getImageData(0,0,canvas.width,canvas.height);
  resetView();
  draw();
}

/* ---------- RESET ---------- */
function resetView(){
  zoom=1;
  offsetX=0;
  offsetY=0;
  zoomSlider.value=100;
  updateTransform();
}

/* ---------- DOWNLOAD ---------- */
function download(){
  const a=document.createElement("a");
  a.download="SharpX.png";
  a.href=canvas.toDataURL();
  a.click();
}
</script>
</body>
</html>
